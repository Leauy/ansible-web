<!DOCTYPE html>  
<html lang="en">  
<head>  
    <title>主页</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    {% include 'head.html' %}
</head>  
<body>
<div class="navbar navbar-default" id="navbar">
            <script type="text/javascript">
                try{ace.settings.check('navbar' , 'fixed')}catch(e){}
            </script>

            <div class="navbar-container" id="navbar-container">
                <div class="navbar-header pull-left">
                    <a href="/proposer/index/" class="navbar-brand">
                        <small>
                            <i class="icon-leaf"></i>
                            版本发布系统系统
                        </small>
                    </a><!-- /.brand -->
                </div><!-- /.navbar-header -->

                <div class="navbar-header pull-right" role="navigation">
                    <ul class="nav ace-nav">

                        <li class="light-blue drop-down">
                            <a data-toggle="dropdown" href="#" class="dropdown-toggle">
                                <img class="nav-user-photo" src="/static/assets/avatars/user.jpg" alt="Jason's Photo">
                                <span class="user-info">
                                    <small>欢迎光临,</small>
                                    {{user.username}}
                                </span>

                                <i class="icon-caret-down"></i>
                            </a>

                            <ul class="user-menu pull-right dropdown-menu dropdown-yellow dropdown-caret ">
                                <li>
                                    <a href="/proposer/changepwd/">
                                        <i class="icon-edit"></i>
                                        修改密码
                                    </a>
                                </li>
                                <li class="divider"></li>

                                <li>
                                    <a href="/proposer/logout/">
                                        <i class="icon-off"></i>
                                        退出
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul><!-- /.ace-nav -->
                </div><!-- /.navbar-header -->
            </div><!-- /.container -->
        </div>

        <div class="main-container" id="main-container">

            <div class="main-container-inner">
                <a class="menu-toggler" id="menu-toggler" href="#">
                    <span class="menu-text"></span>
                </a>

                <div class="sidebar" id="sidebar">
                    <ul class="nav nav-list">
                        <li class="active">
                            <a href="/">
                                <i class="icon-dashboard"></i>
                                <span class="menu-text"> 控制台 - 首页 </span>
                            </a>
                        </li>


                        <li>
                            <a href="#" class="dropdown-toggle">
                                <i class="icon-desktop"></i>
                                <span class="menu-text"> 版本发布系统 </span>

                                <b class="arrow icon-angle-down"></b>
                            </a>  

                            <ul class="submenu">
                                <li>
                                    <a href="/proposer/showHosts/">
                                        <i class="icon-double-angle-right"></i>
                                        主机
                                    </a>
                                </li>

                                <li>
                                    <a href="/proposer/showService/">
                                        <i class="icon-double-angle-right"></i>
                                        服务
                                    </a>
                                </li>

                                <li>
                                    <a href="/proposer/showServiceConfig/">
                                        <i class="icon-double-angle-right"></i>
                                        配置
                                    </a>
                                </li>

                                <li>
                                    <a href="/proposer/showPlayBooks/">
                                        <i class="icon-double-angle-right"></i>
                                        剧本
                                    </a>
                                </li>

                                <li>
                                    <a href="/proposer/showTask/">
                                        <i class="icon-double-angle-right"></i>
                                        任务
                                    </a>
                                </li>

                                <li>
                                    <a href="/proposer/showEnvironment/">
                                        <i class="icon-double-angle-right"></i>
                                        环境
                                    </a>
                                </li>
                                {% if user.is_superuser %}
                                    <li>
                                        <a href="/proposer/showLog/">
                                            <i class="icon-double-angle-right"></i>
                                            日志
                                        </a>
                                    </li>
                                    <li>
                                        <a href="/proposer/showPower/">
                                            <i class="icon-double-angle-right"></i>
                                            授权
                                        </a>
                                    </li>      
                                {% endif%}  
                            </ul>
                        </li>

                        
                    </ul><!-- /.nav-list -->

                    <div class="sidebar-collapse" id="sidebar-collapse">
                        <i class="icon-double-angle-left" data-icon1="icon-double-angle-left" data-icon2="icon-double-angle-right"></i>
                    </div>

                    <script type="text/javascript">
                        try{ace.settings.check('sidebar' , 'collapsed')}catch(e){}
                    </script>
                </div>
        </div>
    </div>

    <div class="main-content">
        <div class="breadcrumbs" id="breadcrumbs">
            <script type="text/javascript">
                try{ace.settings.check('breadcrumbs' , 'fixed')}catch(e){}
            </script>

            <ul class="breadcrumb">
                <li>
                    <i class="icon-home home-icon"></i>
                        <a href="#">Home</a>
                    </li>

                    <li>
                        <a href="#">版本发布系统</a>
                    </li>
                    <li class="active">主页</li>
            </ul>
        </div>
        <div class="page-content">
            <div class="page-header">
                <h1>
                    控制台
                    <small>
                        <i class="icon-double-angle-right"></i>
                        查看
                    </small>
                </h1>
            </div><!-- /.page-header -->
            

            <div class="row">

                <div class="col-xs-12">
                                <!-- PAGE CONTENT BEGINS -->
                    <div class="alert alert-block alert-success">
                        <button type="button" class="close" data-dismiss="alert">
                            <i class="icon-remove"></i>
                        </button>

                        <i class="icon-ok green"></i>

                        欢迎使用
                        <strong class="green">
                            Ansible版本发布系统
                            <small>(v2.0.1)</small>
                        </strong>    
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                        任务：
                        执行distributors_update.yaml文件，将svn上最新或者某个版本的代码更新到10.5.0.58上去。<br>
                        1.创建一个环境类，名称为测试;<br>
                        2.创建一个服务类distributor;<br>
                        3.创建一个主机类，属于测试环境，
                          同时主机上有distributor服务，ip为10.5.0.58,上传密钥文件，以及ssh登录的用户名;<br>
                        4.创建一个剧本类，为更新distributor服务写一个distributors_update.yaml文件，并且上传到服务器;<br>
                        5.根据剧本文件中的变量，创建多个配置类，将配置的名称和配置值，属于哪个环境、服务都保存到数据库中;<br>
                        6.创建一个任务类，选择distributor_update.yaml,测试环境，以及主机10.5.0.58;<br>
                        7.执行<br>
                        </div>
                        <div class="col-sm-6">
                            执行原理:<br>
                                1.首先判断该用户是否又该环境下执行的权限，有执行第2步，没有则提示联系管理员;<br>
                                2.批量执行时，后台得到前端勾选的任务获取它们的id，每一个任务都有相应的发布环境，发布的主机以及对应的剧本文件;<br>
                                3.首先遍历剧本文件，得到需要配置的名称，然后再去查询数据库中的ServiceConfig类，是否每个配置都已经完成，如果没有则中断任务执行过程，并给出提示那些没有进行配置,完成执行第3步;<br>
                                4.根据任务发布主机生成hosts文件<br>
                                5.根据任务发布环境ServiceConfig.objects.filter(environment=)生成config.yaml<br>
                                6.在命令行下执行ansible-playbook -i /xx/hosts  /xx/distributors_update.yaml 将得到的结果返回到界面。<br>
                                7.选择剧本文件的任务执行，就是再第6步执行时，加入 --tags = " include config,..."
                        </div>
                        
                    </div>
                    
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="row header smaller lighter blue">
                                <span class="col-xs-12">
                                    文件 
                                </span><!-- /span -->
                            </h3>

                            <div id="accordion" class="accordion-style1 panel-group">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                                                <i class="icon-angle-right bigger-110" data-icon-hide="icon-angle-down" data-icon-show="icon-angle-right"></i>
                                                    &nbsp;hosts
                                            </a>
                                        </h4>
                                    </div>

                                    <div class="panel-collapse collapse " id="collapseOne">
                                        <div class="panel-body">
                                            Hosts.objects.filter(条件)<br>
                                            查询数据库，获取满足条件的Host类，生成hosts文件。<br>
                                            [hostname]<br>
                                            ip ansible_ssh_user   ansible_ssh_private_key_file<br>
                                            例如：<br>
                                            [distributor.saas.com]<br>
                                            10.5.0.58    
                                            ansible_ssh_user=root 
                                            ansible_ssh_private_key_file=/home/liuyang11/ssh/cloud_rsa
                                        </div>
                                    </div>
                                </div>

                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
                                                <i class="icon-angle-right bigger-110" data-icon-hide="icon-angle-down" data-icon-show="icon-angle-right"></i>
                                                    &nbsp;config.yaml
                                            </a>
                                        </h4>
                                    </div>

                                    <div class="panel-collapse collapse" id="collapseTwo">
                                        <div class="panel-body">
                                            ServiceConfig.objects.filter(environment=?)<br>查询数据库，根据环境获取ServiceConfig类，生成config.yaml<br>
                                            #服务 config<br>
                                            config_name:<br>
                                            config_value:<br>
                                            例如：<br>
                                            # distributor config<br>
                                            distributor_svn: https://192.168.5.246/svn/rsas/branches/RCM-SAAS/src/part_of_rsas/www<br>
                                            distributor_path: /opt/disk2/var/www/distributors<br>
                                            # global config<br>
                                            username:<br> 
                                            password: <br>
                                            svn_version: HEAD<br>
                                            virtualenv: /opt/ENV/ubuntu1227
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseFour">
                                                <i class="icon-angle-right bigger-110" data-icon-hide="icon-angle-down" data-icon-show="icon-angle-right"></i>
                                                    &nbsp;distributors_update.yaml
                                            </a>
                                        </h4>
                                    </div>

                                    <div class="panel-collapse collapse" id="collapseFour">
                                        <div class="panel-body">
                                            要执行的.yaml文件，ansible的剧本文件。<br>
                                            - hosts: distributor.saas.com<br>&nbsp;
                                            user: root<br>&nbsp;
                                            vars: <br>&nbsp;
                                            tasks:<br>&nbsp; 
                                            &nbsp;&nbsp;- name: include config<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;include_vars: config.yaml<br>&nbsp;
                                            &nbsp;&nbsp;- name: stat path<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;stat: path=
                                                                {% autoescape  off %} 
                                                                    {{ 
                                                                {%endautoescape %}
                                                                    distributor_path
                                                                {% autoescape  off %}
                                                                    }} 
                                                                {%endautoescape%}<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;register: path_stat<br>&nbsp;
                                            &nbsp;&nbsp;- name: Remove old backup<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;command: rm -rf 
                                                                {% autoescape  off %} 
                                                                    {{ 
                                                                {%endautoescape %}
                                                                    distributor_path
                                                                {% autoescape  off %} 
                                                                    }} 
                                                                {%endautoescape %}.bak<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;when: path_stat.stat.exists<br>&nbsp;
                                            &nbsp;&nbsp;- name: Backup old code<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;command: mv -f 
                                                                {% autoescape  off %} {{ {%endautoescape %}     
                                                                    distributor_path
                                                                {% autoescape  off %} }} {%endautoescape %} 

                                                                {% autoescape  off %} {{ {%endautoescape %}   
                                                                    distributor_path
                                                                {% autoescape  off %} }} {%endautoescape %}.bak
                                                                <br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;when: path_stat.stat.exists<br>&nbsp;
                                            &nbsp;&nbsp;- name: Update distributors code<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;subversion: repo=
                                                                {% autoescape  off %} {{ {%endautoescape %} 
                                                                    distributor_svn
                                                                {% autoescape  off %} }} {%endautoescape %}
                                                                dest=
                                                                {% autoescape  off %} {{ {%endautoescape %}
                                                                    distributor_path
                                                                {% autoescape  off %} }} {%endautoescape %} export=yes username=
                                                                {% autoescape  off %} {{ {%endautoescape %}
                                                                    username
                                                                {% autoescape  off %} }} {%endautoescape %} password=
                                                                {% autoescape  off %} {{ {%endautoescape %}
                                                                    password
                                                                {% autoescape  off %} }} {%endautoescape %} force=yes revision=
                                                                {% autoescape  off %} {{ {%endautoescape %}
                                                                    svn_version
                                                                {% autoescape  off %} }} {%endautoescape %}
                                                                <br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;register: result<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;ignore_errors: True<br>&nbsp;
                                            &nbsp;&nbsp;- name: Revert code<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;command: mv -f 
                                                                {% autoescape  off %} {{ {%endautoescape %}
                                                                    distributor_path
                                                                {% autoescape  off %} }} {%endautoescape %}.bak {% autoescape  off %} {{ {%endautoescape %}
                                                                    distributor_path
                                                                {% autoescape  off %} }} {%endautoescape %}
                                                                <br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;when: result|failed <br>&nbsp;
                                            &nbsp;&nbsp;- name: Update Schema<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;django_manage: command=migrate app_path=
                                                                {% autoescape  off %} {{ {%endautoescape %}
                                                                    distributor_path
                                                                {% autoescape  off %} }} {%endautoescape %} virtualenv=
                                                                {% autoescape  off %} {{ {%endautoescape %}
                                                                    virtualenv
                                                                {% autoescape  off %} }} {%endautoescape %}
                                                                <br>&nbsp;
                                            &nbsp;&nbsp;- name: Restart Service<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;service: name=
                                                                {% autoescape  off %} {{ {%endautoescape %}
                                                                    item
                                                                {% autoescape  off %} }} {%endautoescape %} state=restarted
                                                                <br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;with_items:<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - uwsgi<br>&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- nginx
                                            <br>&nbsp;
                                        </div>
                                    </div>
                                </div>
                            </div><!-- pane -->
                        </div><!-- /col-sm-8 -->
                        <div class="col-sm-6">
                            <h3 class="row header smaller lighter blue">
                                <span class="col-xs-6"> 表 </span><!-- /span -->
                            </h3>

                            <div id="accordion1" class="accordion-style1 panel-group">
                                <div class="panel panel-default">
                                                <div class="panel-heading">
                                                    <h4 class="panel-title">
                                                        <a class="accordion-toggle  collapsed" data-toggle="collapse" data-parent="#accordion1" href="#host">
                                                            <i class="bigger-110 icon-angle-right" data-icon-hide="icon-angle-down" data-icon-show="icon-angle-right"></i>
                                                            &nbsp;Hosts
                                                        </a>
                                                    </h4>
                                                </div>

                                                <div class="panel-collapse collapse" id="host" style="height: auto;">
                                                    <div class="panel-body">
                                                        class Hosts(models.Model):<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                            id = models.AutoField(primary_key=True)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                            ip = models.GenericIPAddressField()<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                            hostname = models.CharField(max_length=50)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                            chinese_name = models.CharField(max_length=200)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                            ansible_ssh_user = models.CharField(max_length=50)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                            ansible_ssh_private_key_file = models.FileField(upload_to='ssh/')<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                            environment = models.ForeignKey(Environment)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                            services = models.ManyToManyField(Service)<br>&nbsp;&nbsp;&nbsp;&nbsp;

                                                    </div>
                                                </div>
                                            </div>

                                            <div class="panel panel-default">
                                                <div class="panel-heading">
                                                    <h4 class="panel-title">
                                                        <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion1" href="#serviceconfig">
                                                            <i class="bigger-110 icon-angle-right" data-icon-hide="icon-angle-down" data-icon-show="icon-angle-right"></i>
                                                            &nbsp;ServiceConfig
                                                        </a>
                                                    </h4>
                                                </div>

                                                <div class="panel-collapse collapse" id="serviceconfig" style="height: 0px;">
                                                    <div class="panel-body">
                                                        class ServiceConfig(models.Model):<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                        id = models.AutoField(primary_key=True)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                        config_name = models.CharField(max_length=50)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                        config_value = models.CharField(max_length=200,null=True)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                        environment = models.ForeignKey(Environment)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                        service = models.ForeignKey(Service)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="panel panel-default">
                                                <div class="panel-heading">
                                                    <h4 class="panel-title">
                                                        <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion1" href="#playbook">
                                                            <i class="bigger-110 icon-angle-right" data-icon-hide="icon-angle-down" data-icon-show="icon-angle-right"></i>
                                                            &nbsp;Playbook
                                                        </a>
                                                    </h4>
                                                </div>

                                                <div class="panel-collapse collapse" id="playbook" style="height: 0px;">
                                                    <div class="panel-body">
                                                        class PlayBooks(models.Model):<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                        id = models.AutoField(primary_key=True)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                        usages = models.CharField(max_length=50)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                        playbook_file = models.FileField(upload_to='playbooks/')<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                        service = models.ForeignKey(Service)<br>&nbsp;&nbsp;&nbsp;&nbsp;
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                        
                    </div><!-- row-->

                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
